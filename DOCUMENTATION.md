# Project Overview

K2FS is a browsable file server, initially built for managing BitTorrent (BT) downloads, with a particular focus on media files such as images and videos.

## High-level Architecture

-   **Backend:** Written in Go, utilizing the Gorilla Mux router for efficient HTTP request handling.
-   **Frontend:** Employs Vue.js to create a dynamic and responsive user interface, complemented by standard HTML and CSS (Bootstrap) for styling and structure.
-   **Data Storage/Caching:** Leverages Redis for caching metadata and potentially other data to enhance performance. File metadata is also managed by a component referred to as `metaV2`.

## Key Features Summary

-   File browsing capabilities.
-   Integrated media viewing, including an image gallery and video player.
-   File operations such as deleting and labeling files.
-   Search functionality to easily find files.
-   WebDAV support for remote file access and management.

# Setup and Installation

This section guides you through setting up and running the K2FS application.

## Prerequisites

Before you begin, ensure you have the following installed:

-   **Go:** The latest stable version is recommended. Go is required to build the application from source.
-   **Redis Server:** A running Redis instance is needed for caching and metadata management. Ensure it's accessible by the K2FS application.
-   **Node.js and npm:** While the primary frontend assets (`app.js`, `bootstrap.css`) are embedded in the Go binary, Node.js and npm might be required for frontend development or customization tasks.

## Configuration

K2FS is configured primarily through command-line flags at startup:

-   `-i <address>`: Specifies the HTTP service interface address. (Default: `0.0.0.0`)
-   `-l <port>`: Sets the HTTP service listen port. (Default: `:8080`)
-   `-root <path>`: Defines the root directory for the files K2FS will serve and manage. (Default: current directory where the application is run)
-   `-db <path>`: Specifies the directory to store database files. (Default: same as `-root` directory)
-   `-host <url>`: Overwrites the host part of URLs generated by the application (e.g., for links in listings). Syntax: `http://your.domain.com` or `http://your.domain.com:port`. (Default: empty, derived from request)
-   `-static <url>`: Defines a specific host for static files, if served from a different location or CDN. (Default: empty)
-   `-meta <host>`: Specifies the host for the `metaV2` service, which K2FS might interact with for metadata. (Default: `10.43.1.10`)
-   `-df <path>`: Specifies a mount directory to monitor for disk free space. This flag can be used multiple times to monitor multiple paths. (Default: none)

## Building and Running

### From Source

1.  **Build the application:**
    Navigate to the project's root directory and run:
    ```bash
    go build
    ```
    This command compiles the project and creates an executable file named `k2fs` (or `k2fs.exe` on Windows) in the project directory.

2.  **Run the application:**
    Execute the compiled binary, providing any necessary configuration flags. For example:
    ```bash
    ./k2fs -root /mnt/my_media -db /var/lib/k2fs_db -l :8888
    ```
    This command starts the server with `/mnt/my_media` as the root file directory, `/var/lib/k2fs_db` as the database location, and listens on port `8888`.

### Frontend Assets

The core frontend assets (`app.js` and `bootstrap.css`) are embedded directly into the Go binary using `go:embed`. This means that for standard operation, no separate frontend build or serving steps are required.

## Docker Deployment

K2FS can be easily deployed using Docker.

-   **Building Docker Images:**
    Dockerfiles are provided for building images:
    -   `Dockerfile`: For standard amd64 architecture.
    -   `Dockerfile.arm7`: For ARMv7 architecture (e.g., Raspberry Pi).

    You can build an image using a command like:
    ```bash
    docker build -t k2fs-image .
    ```

-   **Using Docker Compose:**
    An example `docker-compose-example.yml` is provided to simplify deployment. It's recommended to copy and customize it:
    1.  Copy `docker-compose-example.yml` to `docker-compose.yml`.
    2.  **Edit `docker-compose.yml`:**
        -   Adjust `volumes`: Map your media directory to `/root` and a persistent storage location for the database to `/db` inside the container. For example:
            ```yaml
            volumes:
              - /path/to/your/media:/root
              - /path/to/your/k2fs_database:/db
            ```
        -   Modify `ports` if you need to change the host port mapping (e.g., `8080:8080`).
        -   Update any command-line flags in the `command` section as needed.
    3.  **Start the service:**
        ```bash
        docker-compose up -d
        ```
    This will pull the necessary images (or build them if specified) and start the K2FS application along with a Redis container if configured in the compose file. Check `docker-compose logs k2fs` to see the application logs.

# Core Features

This section details the main functionalities available to the user within the K2FS application.

## File Browsing

K2FS provides a rich interface for navigating and managing files and directories.

-   **Directory Navigation:** Users can navigate through the directory structure by clicking on folder names. A double-click on a folder will change the current view to that folder's contents.
-   **File/Folder List:** The main view displays a list of files and folders within the current directory. For each item, the following information is typically shown:
    -   Name
    -   Size (human-readable format)
    -   Last Modification Date (formatted for readability)
-   **Breadcrumbs:** A breadcrumb navigation trail is displayed at the top, showing the current path and allowing users to quickly jump to any parent directory in the hierarchy.
-   **"Up" Button:** An "Up" button or link is provided to navigate to the parent directory of the currently viewed folder.
-   **Inline Sub-folder Expansion:** A single-click on a folder name expands it inline, showing its contents (files and sub-folders) directly within the current list. This allows for quick peeking into sub-folders without changing the main directory view. A subsequent single-click on the same folder will collapse it.

## Media Viewing

K2FS includes integrated viewers for images and videos.

### Image Gallery (`photo.html`)

-   **Access:** Typically accessed by navigating to a URL like `/photo/path/to/folder/`, which then renders all images within that specific folder and its subfolders in a continuous, scrollable view.
-   **Features:**
    -   **Scrollable View:** Displays all images in a long, vertical scroll.
    -   **Auto-Scroll:** An "Auto" button initiates automatic scrolling of the page.
    -   **"Go to Top":** A "Top" button appears when scrolling down, allowing quick navigation back to the beginning of the gallery.
    -   **Image Zooming:** Clicking on the main image area in `photo.html` can toggle the body width between `100%` and a fixed `800px`, providing a basic zoom effect.

### Video Player (`player.html`)

-   **Access:** Video files are opened in a dedicated HTML5-based video player, typically by clicking on a video file link in the browser view if the "Open With" option is set to 'browser', or by navigating to a URL like `/player?url=/statics/path/to/video.mp4`.
-   **Custom Controls:**
    -   Play/Pause button.
    -   Progress bar (top of the screen and within a pop-up display).
    -   Time display (current time / total duration).
-   **Touch Gestures (Mobile):**
    -   **Scrubbing:** Horizontal swipe across the video seeks forward or backward.
    -   **Volume Adjustment:** Vertical swipe on the right half of the screen adjusts volume.
    -   **Brightness Adjustment:** Vertical swipe on the left half of the screen adjusts video brightness (visual filter).
    -   **Long-Press for 2x Speed:** A long press (2 seconds) on the video temporarily activates 2x playback speed.
-   **Settings Persistence:** Volume and brightness settings are saved in the browser's `localStorage` and applied when the player is next opened.

### External Player Configuration

K2FS allows users to open video files in external, native applications instead of the built-in web player. This preference can typically be controlled via the "Open With" option found in the user interface, which may save its state in `localStorage`.

-   **For macOS Users:**
    -   It is recommended to use the **IINA** video player.
    -   To enable direct opening of videos from K2FS into IINA, you generally need to install the appropriate IINA browser extension (e.g., "IINA plugin for Chrome" or similar for your browser).

-   **For iOS Users:**
    -   It is suggested to use the **nPlayer** app (which often includes its own browser or sharing capabilities) for opening and playing video files from K2FS.

### Inline Previews (Main Interface)

-   **Image Thumbnails:** Image files listed in the main browser view often show a small thumbnail if the "Easy load picture" feature is triggered or if the file is hovered/clicked.
-   **Folder Thumbnails:** When hovering over or interacting with a folder, the application may attempt to display a thumbnail image from within that folder (handled by `apiThumb` which tries to find a representative image).
-   **"Easy load picture" / "Auto Picture":**
    -   Hovering over or clicking certain file types (especially images) or folders can trigger an inline preview panel on the right side of the file list.
    -   For images, this shows a larger preview.
    -   For folders, it attempts to load and display a representative image from that folder.
    -   This feature is controlled by functions like `showPic`, `easyLoadPic`, and `autoPic` in `app.js`.

## File Operations

K2FS allows users to manage their files and folders through various operations.

-   **Selection:**
    -   Files and folders can be selected using checkboxes next to each item in the list.
    -   The 's' key can be used to toggle the selection state of the currently hovered file.
    -   Selected files are listed in an off-canvas menu.
-   **Deletion:**
    -   Selected files/folders can be marked for deletion. Pressing the 'd' key or using the UI option initiates deletion.
    -   Files are not immediately permanently deleted but are moved to a `.Trash` directory located in the root directory (`-root/.Trash`).
    -   Deleting files from within the `.Trash` directory will permanently remove them.
-   **Labeling/Marking:**
    -   Files and folders can be assigned colored labels (e.g., "danger", "warning", "dark"). This is primarily an API-driven feature (`action=mark=X`) but reflected in the UI by changing the row color or text style.
    -   Keyboard shortcuts are available:
        -   '4' key: Marks selected files with label '4'.
        -   '5' key: Marks selected files with label '5'.
    -   Labels are stored in the file's metadata.
-   **"Open With" Functionality:**
    -   A dropdown menu in the UI allows users to choose how certain files, particularly videos, are opened.
    -   Options typically include 'browser' (uses the integrated `player.html`) or may support system handlers (like 'IINA' for macOS users with the appropriate browser extension).
    -   The choice is stored in `localStorage` via `this.openWith` in `app.js`.

## Search

K2FS provides a search functionality to quickly find files.

-   **Usage:** A search bar is available in the UI. Users can type their query into this bar. The search is triggered by typing and updating the `search` reactive property in `app.js`, which then calls the list API.
-   **Scope:** The search primarily targets file and folder names within the current path or globally depending on the API implementation. The `api.go` mentions `isSearchable` and integration with a search client, suggesting it might also index and search metadata like titles fetched from external sources or embedded in filenames.
-   **Results Display:** Search results are displayed in the main file/folder list area, filtering the view to show only matching items. The query is reflected in the URL (`?search=yourquery`).

# Advanced Features

## WebDAV Access

K2FS supports WebDAV (Web Distributed Authoring and Versioning), allowing users to access and manage files remotely as if they were on a local drive.

-   **Endpoint:** The WebDAV interface is available at the `/webdav/` path (e.g., `http://localhost:8080/webdav/`).
-   **Functionality:** Users can connect to this endpoint using any WebDAV-compatible client (e.g., Windows File Explorer, macOS Finder, Cyberduck). This allows for operations like:
    -   Browsing directories.
    -   Uploading and downloading files.
    -   Creating, deleting, and renaming files and folders.
    -   File locking (using an in-memory lock system).
-   **Authentication:** The provided code does not explicitly detail the authentication mechanism for WebDAV. It might be open by default or rely on a reverse proxy setup for authentication.

## System Monitoring

-   **Disk Free Space:** The application can monitor and display the disk free space for specified mount points.
    -   Configuration: Uses the `-df <path>` command-line flag (can be specified multiple times).
    -   Display: Information about disk usage (percentage used) is shown in the UI, often highlighted with colors (e.g., warning for high usage, danger for critical usage). This is fetched via the `/api?action=df` endpoint.
-   **Cache Performance:** Logs related to cache length, hit rate, and lookup count are periodically outputted by the server, indicating internal monitoring of Redis cache performance.

## Short URLs

-   **Functionality:** The system has a mechanism for creating and using short URLs for files, accessible via the `/s/` path prefix.
-   **Usage:** If a short URL is defined for a file, accessing `/s/<short_code>` will redirect to the actual file. This can be useful for sharing direct links to files.
-   **Static Host Overwrite:** The `-static <url>` flag can be used to prefix these short URLs, allowing files to be served from a different domain or CDN.

## Background Tasks

K2FS performs several background tasks to maintain the file index and system health:

-   **Indexing:** Periodically, the system re-indexes the `rootDir` to discover new files and update metadata.
-   **Orphan Removal:** Removes orphaned metadata entries for files that no longer exist.
-   **Cache Size Update:** Regularly updates cached information about directory sizes.
These tasks run automatically at intervals (e.g., every 55 minutes).

# API Endpoints

K2FS exposes several HTTP API endpoints for frontend interaction and potentially third-party integrations. The base path for most of these is `/api`.

-   **`GET /api?action=df`**:
    -   **Description:** Fetches disk free space information for monitored mount points.
    -   **Response:** JSON array with disk usage details.
-   **`POST /api?action=list`**:
    -   **Description:** The primary endpoint for listing directory contents and search results.
    -   **Request Body (JSON):**
        ```json
        {
          "path": "/current/directory/path", // The path to list
          "list": "read", // Or other modes like "find" for subListApi
          "search": "search_query", // Optional: search query
          "openWith": "browser", // Optional: user's openWith preference
          "localStore": true, // Optional: user's localStore preference
          "limit": 200, // Optional: limit for pagination
          "page": 1 // Optional: page number for pagination
        }
        ```
    -   **Response:** JSON object containing directory information (`Dir`, `UpDir`) and a list of files/folders (`Files`) with their metadata.
-   **`POST /api?action=thumb`**:
    -   **Description:** Retrieves a thumbnail for a given folder path. It attempts to find a suitable image within the folder to use as a preview.
    -   **Request Body (JSON):**
        ```json
        {
          "path": "/path/to/folder"
        }
        ```
    -   **Response:** JSON object containing data for the thumbnail, such as its path and dimensions.
-   **`GET /api?action=session&sortby=<field>&desc=<0|1>`**:
    -   **Description:** Sets sorting preferences for the user's session (e.g., sort by name, size, date, in ascending or descending order).
    -   **Query Parameters:**
        -   `sortby`: Field to sort by (e.g., "name", "size", "date").
        -   `desc`: `1` for descending, `0` for ascending.
    -   **Response:** Confirmation message.
-   **`POST /api?action=operation`**:
    -   **Description:** Performs file operations like delete or mark/label.
    -   **Request Body (JSON):**
        ```json
        {
          "files": { "hash_of_file1": true, "hash_of_file2": true }, // Map of selected file hashes
          "dir": "/current/directory/path", // Current directory context
          "action": "delete" // Or "mark=4", "mark=5", etc.
        }
        ```
    -   **Response:** Confirmation or error message.

Other notable paths:

-   **`/statics/*`**: Serves static files (images, videos, etc.) from the `rootDir`.
-   **`/.local/*`**: Serves local static assets for the UI (e.g., JavaScript libraries, CSS).
-   **`/photo/*`**: Endpoint for the image gallery view.
-   **`/player`**: Endpoint for the video player view.
-   **`/webdav/*`**: Endpoint for WebDAV access.
-   **`/s/*`**: Handles short URL redirections.

# Customization

## Frontend

-   **Styling:** The primary styling is done using Bootstrap CSS (`bootstrap.css`), which is embedded in the Go binary. Customizations would involve modifying this CSS or overriding styles.
-   **JavaScript Logic and Frontend Internals:**
    The core of the frontend interactivity is managed by `app.js`, which is also embedded within the Go binary. This script initializes a main Vue.js instance responsible for rendering and managing the primary user interface. Understanding its structure is key to frontend customization:
    -   **Vue.js Instance:** A single, comprehensive Vue instance orchestrates most of the frontend.
    -   **Data Properties:** This instance holds various data properties that represent the state of the application. Key examples include:
        -   `path`: The current directory path being viewed.
        -   `files`: An array of file and folder objects displayed in the list.
        -   `select`: An object tracking currently selected files for operations.
        -   `search`: The current search query string.
        -   `subListOpen` and `subList`: Manage inline expanded subfolders.
        -   `openWith`: User's preference for opening files.
    -   **Methods:** A rich set of methods within the Vue instance handles user interactions and application logic. These include:
        -   Directory navigation (`clickDir`, `clickUpDir`, `clickSubDir`).
        -   File interaction (`clickFile`, `showPic`, `hidePic`, `autoPic`).
        -   Calling backend operations (`operation` for delete/mark, `sortByApi`).
        -   Fetching data from the server (`listApi` for file lists, `listSubApi` for inline folders, `getDf` for disk free space).
    -   **API Interaction:** The frontend communicates with the backend Go server through HTTP requests. The `axios` library is used for making these API calls to endpoints like `/api?action=list`, `/api?action=operation`, `/api?action=thumb`, etc. Responses from these APIs typically update the Vue instance's data properties.
    -   **Reactivity:** Vue.js's reactivity system automatically updates the HTML view whenever the underlying data properties change. For example, when `this.files` is updated after an API call, the list of files displayed to the user re-renders to reflect the new data.
    -   **Event Handling:** Includes handling for clicks, double-clicks (distinguished by a timer in `onClick`), keydown events (for shortcuts like 'd' for delete, 's' for select), and mouseover events (for `hoveredFile`).
    -   **Local Storage:** Uses `localStorage` to persist user preferences like `openWith` and `localStore`.

    Significant changes to frontend behavior, such as adding new interactive features or modifying existing ones, would involve working with this Vue instance in `app.js` and then recompiling the Go application to include the updated JavaScript.
-   **HTML Templates:**
    -   `tmpl.html`: Main HTML structure for the file browser interface.
    -   `photo.html`: Template for the image gallery.
    -   `player.html`: Template for the video player.
    These are embedded in the Go binary. Modifying them requires recompiling.

## Backend

-   **Go Code:** All backend logic, including API handling, file operations, and serving, is in the Go source files. Customizations involve modifying the Go code and recompiling.
-   **Configuration Flags:** As detailed in the "Setup and Installation" section, various command-line flags allow for runtime configuration without code changes.
-   **Search Integration:** The search functionality (`lib.NewSearchClient()`) appears to be pluggable or configurable to some extent, potentially allowing integration with different search backends or customization of search behavior by modifying the `isSearchable` logic or the search client implementation.

# Troubleshooting

-   **Check Logs:** The application outputs logs to standard output/error. These logs are the first place to check for any issues. Pay attention to messages related to file access, Redis connectivity, and API request processing.
-   **Permissions:** Ensure the user running the K2FS application has appropriate read/write permissions for the `rootDir` and `dbDir`.
-   **Redis Connectivity:** Verify that the Redis server is running and accessible from the K2FS application host on the configured address/port.
-   **Port Conflicts:** Ensure the port specified with `-l` (default `:8080`) is not already in use by another application.
-   **File Paths:** When using command-line flags like `-root` or `-db`, ensure the paths are correct and accessible.
-   **Browser Cache/Developer Tools:** For frontend issues, try clearing the browser cache or using browser developer tools to inspect network requests, JavaScript console errors, and HTML structure.
-   **Indexing Delays:** If newly added files don't appear immediately, remember that indexing runs periodically. Wait for the next indexing cycle or consider if a manual re-index trigger is available/needed (not explicitly mentioned, but a common feature in similar systems).
-   **Docker Specifics:**
    -   **Volume Mounts:** Double-check that Docker volume mounts are correctly mapping your host directories to the container paths (`/root`, `/db`).
    -   **Networking:** Ensure Docker container networking allows K2FS to reach Redis if it's in a separate container or on the host.
    -   **Logs:** Use `docker-compose logs k2fs` (or `docker logs <container_id>`) to view application logs when running in Docker.
